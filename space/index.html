<!DOCTYPE html>
<html lang="en">
  <head>
    <title>knoxel space prototype</title>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="space/style.css">
    <script src="space/colors.js"></script>
    <script src="space/intersect.js"></script>
    <script src="space/script.js"></script>
  </head>  
  <body onload="onLoadBody(event);">
    <svg class="spaceRoot" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
      <defs>
        <marker id="arrowTail" markerWidth="2" markerHeight="4" refX="1" refY="2" orient="auto">
          <polygon points="1 0, 1 4" stroke="#160f19" />
        </marker>
        <marker id="arrowHead" markerWidth="5" markerHeight="4" refX="0.5" refY="2" orient="auto">
          <polygon points="0 0, 5 2, 0 4" fill="#160f19" />
        </marker>
        <marker id="crossTail" markerWidth="4" markerHeight="6" refX="3" refY="3" orient="auto">
          <rect x="1" y="1" width="2" height="4" stroke="#160f19" fill="none"></rect>
        </marker>
        <marker id="crossHead" markerWidth="6" markerHeight="6" refX="1.5" refY="3" orient="auto">
          <circle cx="3" cy="3" r="1.5" stroke="#160f19" fill="none"></circle>
        </marker>
        <marker id="spaceHead" markerWidth="6" markerHeight="6" refX="1.5" refY="3" orient="auto">
          <polyline points="1 1 5 3 1 5" stroke="#160f19" fill="none" />
        </marker>
      </defs>
      <g id="record">
        <foreignObject x="0" y="0" width="0" height="0"></foreignObject>
      </g>
      <g id="knoxels"></g>
      <g id="arrows"></g>
      <g id="bubbles"></g>
      <g id="ghosts"></g>
      <g id="arrowGhosts"></g>
    </svg>
    <div class="spaceBack">
      <svg class="backArrow" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
        <polygon id="backArrowShape" points="4,38 36,38 20,6" stroke-width="4" stroke="#ffff00" fill="#ffff00" />
      </svg>
    </div>
    <div class="spaceForward">
      <svg class="forwardArrow" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
        <polygon id="forwardArrowShape" points="4,3 36,3 20,35" stroke-width="4" stroke="#ffff00" fill="#ffff00" />
      </svg>
    </div>
    <div id="spaceMapButton" class="spaceMap">
      <svg class="mapIcon" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
        <polygon id="mapShape" points="2,2 38,2 38,38 2,38" stroke-width="4" stroke="#ffff00" fill="#ffff00" />
        <circle cx="12" cy="12" r="6" stroke="#160f19" stroke-width="2" fill="#d8b621"></circle>
        <circle cx="28" cy="12" r="6" stroke="#160f19" stroke-width="2" fill="#dc286f"></circle>
        <circle cx="12" cy="28" r="6" stroke="#160f19" stroke-width="2" fill="#36945b"></circle>
        <circle cx="28" cy="28" r="6" stroke="#160f19" stroke-width="2" fill="#5571f1"></circle>
      </svg>
    </div>
    <div id="spaceHostButton" class="spaceHost">
      <svg class="hostIcon" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
        <polygon id="hostShape" points="2,2 38,2 38,38 2,38" stroke-width="4" stroke="#ffff00" fill="#ffff00" />
        <circle cx="18" cy="18" r="8" fill="#d8b621" stroke="#160f19" stroke-width="2" stroke-dasharray="0 4" stroke-linecap="square"></circle>
        <circle cx="26" cy="26" r="8" fill="#d8b621" stroke="#160f19" stroke-width="2" opacity="0.5"></circle>
      </svg>
    </div>
    <div id="autosizer"></div>
    <dialog id="colorpicker" onkeypress="onKeyPressColorpicker(event);">
      <p>
        Edit knyte color
      </p>
      <input>
      <p id="colorset"></p>
      <p>
        <button onclick="onClickColorpickerClose();">
          cancel (esc)
        </button>
        <button onclick="onClickColorpickerOk();">
          OK (enter)
        </button>
      </p>
    </dialog>
    <script>
      function onKeyPressColorpicker(e)
      {
        if (e.code === 'Enter' && !e.shiftKey && !e.altKey && !e.metaKey)
          onClickColorpickerOk();
        else if (e.code === 'Escape' && !e.shiftKey && !e.altKey && !e.metaKey)
          onClickColorpickerClose();
      }
      
      function onClickColorpickerClose()
      {
        const colorpickerDialog = document.getElementById('colorpicker');
        colorpickerDialog.close();  
      }
      
      function onClickColorpickerOk()
      {
        const colorpickerDialog = document.getElementById('colorpicker');
        const colorpickerInput = colorpickerDialog.getElementsByTagName('input')[0];
        colorpickerDialog.returnValue = colorpickerInput.value;
        colorpickerDialog.close();
      }
      
      function onClickColorpickerColorButton(e)
      {
        const colorpickerDialog = document.getElementById('colorpicker');
        const colorpickerInput = colorpickerDialog.getElementsByTagName('input')[0];
        colorpickerInput.value = e.target.dataset.color;
        onClickColorpickerOk();
      }
      
      const colorset = document.getElementById('colorset');
      for (let i = 0; i < visualThemeColors.elements.length; ++i)
      {
        const color = visualThemeColors.elements[i];
        colorset.innerHTML += '<button data-color="' + color + '" style="background-color: ' + color + ';" ' +
          'class="colorpickerColorButton" onclick="onClickColorpickerColorButton(event);"></button>';
      }
    </script>
    <dialog id="recordeditor" onkeypress="onKeyPressRecordeditor(event);">
      <p>
        Edit knyte record as
        <select id="recordtype" onchange="onChangeRecordtype();">
          <option value="oneliner">oneliner</option>
          <option value="multiliner">multiliner</option>
          <option value="interactive">interactive</option>
        </select>
      </p>
      <div style="min-height: 256px;">
        <div id="recorddiv.oneliner" class="recorddiv">
          <input id="recordinput.oneliner" size="64">
        </div>
        <div id="recorddiv.multiliner" class="recorddiv">
          <textarea id="recordinput.multiliner" style="white-space: pre; min-width: 320px; min-height: 64px;"
            rows="16" cols="80" onkeydown="onKeyDownRecordeditor(event);"></textarea>
        </div>
        <div id="recorddiv.interactive" class="recorddiv">
          <textarea id="recordinput.interactive" style="white-space: pre; min-width: 320px; min-height: 64px;"
            rows="15" cols="80" onkeydown="onKeyDownRecordeditor(event);"></textarea>
          <div style="text-align: left;">
            <button onclick="onClickRunBlock();">run block</button>
          </div>
        </div>
      </div>
      <p>
        <span>
          press esc to cancel
        </span>
        <button onclick="onClickRecordeditorOk();">
          OK (alt+enter)
        </button>
      </p>
    </dialog>
    <script>
      function onKeyPressRecordeditor(e)
      {
        if (e.code === 'Enter' && !e.shiftKey && e.altKey && !e.metaKey)
          onClickRecordeditorOk();
        else if (e.code === 'Escape' && !e.shiftKey && !e.altKey && !e.metaKey)
          onClickRecordeditorClose();
      }
      
      function onClickRecordeditorOk()
      {
        const recordeditorDialog = document.getElementById('recordeditor');
        const recordtype = document.getElementById('recordtype').value;
        recordeditorDialog.returnValue = document.getElementById('recordinput.' + recordtype).value;
        recordeditorDialog.close();
      }
      
      function onChangeRecordtype()
      {
        const recordtype = document.getElementById('recordtype').value;
        const recorddivs = document.getElementsByClassName('recorddiv');
        for (let i = 0; i < recorddivs.length; ++i)
          recorddivs[i].style.display = 'none';
        document.getElementById('recorddiv.' + recordtype).style.display = 'block';
      }

      function onClickRunBlock()
      {
        document.getElementById('recordinput.interactive').value = codeTemplates.runBlock;
      }
      
      function onKeyDownRecordeditor(e)
      {
        function getTextLineWhitespacePositions(text, caretPosition)
        {
          // find start of the current line
          let lineStart = caretPosition;
          while (lineStart > 0 && text[lineStart-1] !== '\n')
            --lineStart;
          // find start of nonspace symbols of the current line
          let whitespaceEnd = lineStart;
          while (text[whitespaceEnd] === ' ' || text[whitespaceEnd] === '\t')
            ++whitespaceEnd;
          return {text, caretPosition, lineStart, whitespaceEnd};
        }
        
        if (e.code === 'Enter' && !e.shiftKey && !e.altKey && !e.metaKey)
        {
          const {text, caretPosition, lineStart, whitespaceEnd} = getTextLineWhitespacePositions(
            e.target.value, e.target.selectionStart);
          if (whitespaceEnd > lineStart)
          {
            // Insert carriage return and indented text
            document.execCommand('insertText', false, 
              '\n' + text.substr(lineStart, Math.min(whitespaceEnd, caretPosition)-lineStart));
            // Scroll caret visible
            e.target.blur();
            e.target.focus();
            e.preventDefault();
          }
        }
        if(e.code === 'Tab' && !e.altKey && !e.metaKey)
        {
          const {caretPosition, lineStart, whitespaceEnd} = getTextLineWhitespacePositions(
            e.target.value, e.target.selectionStart);
          const reverseTab = (lineStart < whitespaceEnd && caretPosition <= whitespaceEnd);
          if (e.shiftKey && reverseTab)
          {
            if (caretPosition > lineStart)
              document.execCommand('delete');
            else
              document.execCommand('forwardDelete');
          }
          else if (!e.shiftKey || caretPosition > lineStart)
            document.execCommand('insertText', false, '\t');
          e.preventDefault();
        }
      }
      
      onChangeRecordtype();
    </script>
  </body>
</html>